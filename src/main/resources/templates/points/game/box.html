<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
				xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
				xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
				layout:decorate="~{layouts/layout}">

<head>
<meta charset="UTF-8">
<title>OYEZ - 랜덤박스</title>

<th:block layout:fragment="css">
	<!-- POPUP -->
	<link rel="stylesheet" th:href="@{/css/app/popup.css}" />
	<!-- GAME - BOX -->
	<link rel="stylesheet" th:href="@{/css/app/box.css}" />
	<!-- GOOGLE ICON -->
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
</th:block>

</head>

<body>
	
	<!-- ADMIN_DETAIL : CONTENT -->
	<main layout:fragment="content" class="form__box">
		<div class="box__btn">
			<div class="flow-text">
				<span class="flow-wrap">LOGIN BONUS !! LOGIN BONUS !!</span>
			</div>
			<div style="margin-top: 1rem;">
				<button id="getRandomBox" style="margin-right: 1rem;">RANDOM</button>
				<button id="get100Box">100 POINT</button><br>
			</div>
			<div style="margin-top: 2rem;">
				<span>* 랜덤박스는 확률에 따라<br><span style="font-weight: 600;">100 ~ 1000 POINT</span> 가 적립됩니다.</span><br>
				<hr style="border: .5px solid #FFCECE; margin: 2rem 0 2rem 0;">
				<span style="font-size: .85rem;">
					1000 POINT (3%)<br>
					500 POINT (6%)<br>
					300 POINT (11%)<br>
					150 POINT(31%)<br>
					100 POINT (49%)
				</span>
			</div>
		</div>
		<div>
			<img id="getRoadingBox" src="/img/app/points/game/randomBox.gif" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: -1; width: 450px; opacity: 0;">
		</div>
	</main>
	
	<!-- ADMIN_DETAIL : SCRIPT -->
	<th:block layout:fragment="script">
		<!-- SETTINGS -->
		<script th:inline="javascript">
			var userId = [[ ${userId} ]];
			
			const today = new Date();
			const month = today.getMonth() + 1;
			const date = today.getDate();
			const getRandomBox = document.querySelector('#getRandomBox');
			const get100Box = document.querySelector('#get100Box');
			
			getRandomBox.addEventListener('click', (event) => {
				const result = getPointsBox();
				savePoints(result);
			});
			
			get100Box.addEventListener('click', (event) => {
				const result = "100";
				savePoints(result);
			});
			
			const getPointsBox = function() {
				const ranNum = Math.floor((Math.random() * 99) +1);
	
	            // 경품 생성
	            const gift = ['1000', '500', '300', '150', '100'];
	            // 확률 생성
	            const pbt = [3, 6, 11, 31, 49];
	            // 리턴 경품 값
	            let res = '';
	
	            for (let i = 0; i < gift.length; i++) {
	
	                if(pbt[i] >= ranNum){
	                    res = gift[i];
	                    return res;
	                }
	                else if (pbt[pbt.length - 1] < ranNum) {
	                    res = gift[gift.length - 1];
	                    return res;
	                }
	            }
			}
			
			// 포인트 적립
			function savePoints(result) {
				var pointsCd = "1";
				var points = result;
				
				var headers = { "Content-Type": "application/json", "X-HTTP-Method-Override": "POST" };
				var params = { "pointsCd": pointsCd, "points": points, "userId": userId };
				
				//console.log("params : " + JSON.stringify(params));
				
				$.ajax({
					url: "/points/save",
					type: "POST",
					headers: headers,
					dataType: "JSON",
					data: JSON.stringify(params),
					success: function(response) {
						if(response.result == false) {
							swal.fire({
								text: '포인트 적립에 실패했습니다.',
			    				icon: 'warning',
			    				confirmButtonColor: '#3085d6',
			    				confirmButtonText: '확인'
			    			});
							return false;
						} else if(response.result == true) {
							const getRoadingBox = document.getElementById('getRoadingBox');
							getRoadingBox.style.zIndex = '1';
							getRoadingBox.style.opacity = '1';
							
							setTimeout(function() {
								swal.fire({
									text: result + ' POINT 가 적립되었습니다.',
				    				icon: 'success',
				    				confirmButtonColor: '#3085d6',
				    				confirmButtonText: '확인'
				    			}).then((result) => {
				    				if(result.isConfirmed) {
				    					location.href = '/';
				    				}
				    				return true;
				    			});								
							}, 2000);
						}
					},
					error: function(xhr, status, error) {
						swal.fire({
							text: '잠시 후 재시도 바랍니다.',
							footer: '서버와의 통신 에러입니다.',
							icon: 'error',
							confirmButtonColor: '#3085d6',
							confirmButtonText: '확인'
						});
						return false;
					}
				});
			}
		</script>
		<!-- LOADING -->
		<script type="text/javascript" src="/js/lib/loadingoverlay.min.js"></script>
		<script type="text/javascript" src="/js/app/loading.js"></script>
	</th:block>
	
	
</body>

</html>