<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
				xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
				xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
				layout:decorate="~{layouts/layout}">

<head>
<meta charset="UTF-8">
<title>toy, 게시판</title>

<th:block layout:fragment="css">
	<!-- RESET, DEFAULT -->
	<link rel="stylesheet" th:href="@{/css/app/reset.css}" />
	<link rel="stylesheet" th:href="@{/css/lib/bootstrap.min.css}" />
	<link rel="stylesheet" th:href="@{/css/app/index.css}" />
	<link rel="stylesheet" th:href="@{/css/app/default.css}" />
	<!-- POPUP -->
	<link rel="stylesheet" th:href="@{/css/app/popup.css}" />
	<!-- BOARD -->
	<link rel="stylesheet" th:href="@{/css/app/board.css}" />
	<link rel="stylesheet" th:href="@{/css/app/button.css}" />
	<!-- GOOGLE ICON -->
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
</th:block>

</head>

<body>
	
	<div layout:fragment="content" class="container">
		
		<!-- 내용 수정 모달 -->
		<div id="commentModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="commentModalLabel" aria-hidden="true" style="z-index: 1001;">
		    <div class="modal-dialog modal-dialog-centered" role="document">
		        <div class="modal-content">
		            <div class="modal-header">
		                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		            </div>
		            <div class="modal-body">
		                <form>
		                    <div class="form-group">
		                        <label for="modalWriter" class="col-form-label">글쓴이</label>
		                        <input type="text" id="modalWriter" class="form-control" readonly />
		                    </div>
		                    <div class="form-group">
		                        <label for="modalContent" class="col-form-label">내용</label>
		                        <textarea id="modalContent" class="form-control" placeholder="내용을 입력해 주세요."></textarea>
		                    </div>
		                </form>
		            </div>
		            <div class="modal-footer">
		                <button type="button" id="btnCommentUpdate" class="btn btn-primary waves-effect waves-light" onclick="updateComment();">수정</button>
		                <button type="button" id="btnCommentDelete" class="btn btn-danger waves-effect waves-light">삭제</button>
		            </div>
		        </div>
		    </div>
		</div>
		
		<!-- 현재 경로 -->
		<div class="page_tits">
		    <p class="path"><strong>현재 위치 :</strong> <span>게시판 리스트</span> <span><b>상세보기</b></span> <span>작성/수정</span></p>
		</div>
		
		<!-- 본문 내용 -->
		<div class="content">
			<input type="hidden" id="writer" name="writer" th:value="${board.writerId}">
			<input type="hidden" id="userId" name="userId" th:value="${userId}">
			
	        <section>
	        	<p class="board-btn">
	                <a class="btn btn-primary" onclick="goWritePage();">수정</a>
	                <button class="btn btn-danger" onclick="deleteBoard();">삭제</button>
	                <a href="javascript:history.go(-1)" class="btn btn-light" onclick="goListPage();">뒤로</a>
	            </p>
	            <div class="board-title">
		            <span class="board-title1">[[ ${board.title} ]]</span>
		            <button id="board-likes" class="btns btn_mid board-likes"><img src="/img/app/board/unlikes.png"></button>
	            </div>
	            <div class="board-info">
		            <span><span class="board-writer">글쓴이</span>[[ ${board.writer} ]]</span>
		            <span th:text="${#temporals.format( board.IDate, 'yyyy.MM.dd HH:mm' )}"></span>
		            <span class="board-viewCnt1"><span class="board-view">조회수</span>[[ ${board.viewCnt} ]]</span>	            
	            </div>
	            <div class="board-contents">
		            <p class="board-content" th:utext="${board.content}"></p>            	
	            </div>
	        </section>
	    </div>
	    
	    <!-- 댓글 리스트 -->
		<div class="box-content">
			<div class="card-content">
				<div class="clearfix comment-main">
					<i class="fas fa-comments"></i><span class="box-title pull-left comment-main-name">&nbsp;<span th:text="${comment}"></span>개의 댓글</span>
				</div>

				<form class="form-horizontal form-view" onsubmit="return false;">
					<div class="input-group margin-bottom-20 comment-input-group">
						<input type="text" id="content" class="form-control comment-input" placeholder="댓글을 쓰려면 로그인이 필요합니다." style="margin-left: 15px; height: 60px;" onkeyup="enterkey();"/>
						<div class="comment-input-btn">
							<button type="button" class="btn waves-effect waves-light" th:onclick="insertComment([[ ${board.id} ]]);">
							<i class="fa fa-commenting" aria-hidden="true"></i>
							</button>
						</div>
					</div>
					<ul class="notice-list comment-list"></ul>
				</form>
			</div>
		</div>
	</div>
	
	<th:block layout:fragment="script">
		<!-- FONT AWESOME -->
		<script src="https://kit.fontawesome.com/77ad8525ff.js"></script>
		<!-- Jquery, Bootstrap -->
		<script type="text/javascript" src="/js/lib/jquery.min.js"></script>
		<script type="text/javascript" src="/js/lib/bootstrap.min.js"></script>
		<script type="text/javascript" src="/js/app/header.js"></script>
		<!-- POPUP -->
		<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
		<script type="text/javascript" src="/js/app/popup.js"></script>
		<!-- BOARD -->
		<script type="text/javascript" src="/js/lib/moment.js"></script>
		<script type="text/javascript" src="/js/app/board.js"></script>
		<script th:inline="javascript">
		/*<![CDATA[*/
			
			// 게시글 삭제
	        function deleteBoard() {
	            const id = [[ ${board.id} ]];
	            if ( !confirm("게시글을 삭제할까요?") ) {
	                return false;
	            }
	            
	            const writer = document.getElementById('writer').value;
	        	const userId = document.getElementById('userId').value;
	        	
	        	if(writer != userId) {
	        		alert("권한이 없는 게시글입니다.");
	        	} else {
	        		let inputHtml = '';
		            new URLSearchParams(location.search).forEach((value, key) => {
		                inputHtml += `<input type="hidden" name="${key}" value="${value}" />`;
		            })
		            
		            const formHtml = `
		                <form id="deleteForm" action="/board/delete" method="post">
		                    ${inputHtml}
		                </form>
		            `;
		            
		            const doc = new DOMParser().parseFromString(formHtml, 'text/html');
		            const form = doc.body.firstChild;
		            document.body.append(form);
		            document.getElementById('deleteForm').submit();
	        	}
	        }
		
			// 게시글 리스트 페이지로 이동
	        function goListPage() {
	            const queryString = new URLSearchParams(location.search);
	            queryString.delete('id');
	            location.href = '/board' + '?' + queryString.toString();
	        }
			
			// 게시글 수정 페이지로 이동
	        function goWritePage() {
	        	const writer = document.getElementById('writer').value;
	        	const userId = document.getElementById('userId').value;
	        	
	        	if(writer != userId) {
	        		alert("권한이 없는 게시글입니다.");
	        	} else {
			        location.href = '/board/write' + location.search;
	        	}
	        	/* th:href="@{/board/write( id=${board.id} )}"  */
	        }
			
	        $(function() {
				printCommentList();
			});
	        
			function openModal(id, writer, content) {
				
				$("#commentModal").modal("toggle");
				
				document.getElementById("modalWriter").value = writer;
				document.getElementById("modalContent").value = content;
				
				document.getElementById("btnCommentUpdate").setAttribute("onclick", "updateComment("+ id +")");
				document.getElementById("btnCommentDelete").setAttribute("onclick", "deleteComment("+ id +")");
			}
			
			// 댓글 작성
			function insertComment(boardId) {

				var content = document.getElementById("content");
				if (isEmpty(content.value) == true) {
					content.setAttribute("placeholder", "댓글을 입력해 주세요.");
					content.focus();
					return false;
				}

				var uri = [[ @{/comments} ]];
				var headers = { "Content-Type": "application/json", "X-HTTP-Method-Override": "POST" };
				var params = { "boardId": boardId, "content": content.value, "writerId": [[ ${userId} ]], "writer": [[ ${userName} ]] };
				
				$.ajax({
					url: uri,
					type: "POST",
					headers: headers,
					dataType: "json",
					data: JSON.stringify(params),
					success: function(response) {
						if(response.result == false) {
							alert("댓글 등록에 실패하였습니다.");
							console.log(response.count);
							return false;
						}
						
						printCommentList();
						content.value = "";
					},
					error: function(xhr, status, error) {
						alert("잠시후 재시도 해주세요.");
						return false;
					}
				});
			}
			
			// 엔터키 댓글 작성
			function enterkey() {
				const boardId = [[ ${board.id} ]];
				
				if(event.keyCode == 13) {
					insertComment(boardId);
				}
			};
			
			// 댓글 수정
			function updateComment(id) {
				var writer = document.getElementById("modalWriter");
				var content = document.getElementById("modalContent");
				
				var uri = [[ @{/comments/} ]] + id;
				var headers = { "Content-Type": "application/json", "X-HTTP-Method-Override": "PATCH" };
				var params = { "id": id, "writer": writer.value, "content": content.value };
				
				$.ajax({
					url: uri,
					type: "PATCH",
					headers: headers,
					dataType: "json",
					data: JSON.stringify(params),
					success: function(response) {
						if (response.result == false) {
							alert("댓글 수정에 실패하였습니다.");
							return false;
						} else if(response.result == "isUnauthorized") {
							alert(response.message);
						}
						printCommentList();
						$("#commentModal").modal("hide");
					},
					error: function(response) {
						alert("잠시후 재시도 해주세요.");
						return false;
					}
				});
			}
			
			// 댓글 삭제
			function deleteComment(id) {
				
				if (!confirm('댓글을 삭제할까요?')) {
					return false;
				}
				
				var uri = [[ @{/comments/} ]] + id;
				var headers = {"Content-Type": "application/json", "X-HTTP-Method-Override": "DELETE"};
				
				$.ajax({
					url: uri,
					type: "DELETE",
					headers: headers,
					dataType: "json",
					success: function(response) {
						if (response.result == false) {
							alert("댓글 삭제에 실패하였습니다.");
							return false;
						} else if(response.result == "isUnauthorized") {
							alert(response.message);
						} else {
							alert(response.message);
						}
						printCommentList();
						$("#commentModal").modal("hide");							
					},
					error: function(xhr, status, error) {
						alert("에러가 발생하였습니다.");
						return false;
					}
				});
			}
			
			// 댓글 리스트 출력
			function printCommentList() {
				
				var uri = [[ @{/comments/} + ${board.id} ]];
				
				$.get(uri, function(response) {
					if (isEmpty(response) == false) {
						var commentsHtml = "";
						console.log(response);

						$(response.commentList).each(function(id, comment) {
							commentsHtml += `
								<li class="comment-li">
									<img src="/img/app/chat/chat.png" class="comment-img">
									<strong class="name comment-name">${comment.writer}</strong>
									<span class="time comment-time">${timeForToday(moment(comment.IDate).format('YYYY-MM-DD HH:mm'))}</span>
									<span onclick="openModal(${comment.id}, '${comment.writer}', '${comment.content}' )" class="material-symbols-outlined" style="cursor: pointer; font-size: 15px;">${comment.deleteYn != 'Y' ? 'edit' : ''}</span>
									<br>
									<span class="desc comment-content">${comment.content}</span>
								</li>
							`;
						});
						
						$(".notice-list").html(commentsHtml);
					}
				}, "json");
			}
		/*]]>*/
		</script>
	</th:block>
	
	
</body>

</html>